services:
  # --- 0. Init Permissions (Fix logs volume rights) ---
  init-perms:
    image: alpine:latest
    command: sh -c "mkdir -p /var/log/pixel && chmod 777 /var/log/pixel"
    volumes:
      - logs_volume:/var/log/pixel
    networks:
      - pixel_net

  # --- 0.5. Pixel Builder ---
  pixel-builder:
    image: node:18-alpine
    container_name: pixel_pixel_builder
    volumes:
      - ./tracker:/src
      - pixel_dist:/dist
    working_dir: /src
    # Build src/index.js -> /dist/pixel.js using Rollup + Terser
    command: sh -c "npm install -g rollup terser && rollup src/index.js --format iife --name SpyPixel --file dist/pixel.unminified.js && terser dist/pixel.unminified.js -c -m -o /dist/pixel.js"
    networks:
      - pixel_net

  # --- 1. Pixel (Nginx + Lua) ---
  pixel:
    build:
      context: .
      dockerfile: ops/pixel.Dockerfile
    container_name: pixel_pixel
    restart: always
    ports:
      - "${PIXEL_PORT}:80" # Expose pixel
    environment:
      - MAXMIND_ACCOUNT_ID=${MAXMIND_ACCOUNT_ID}
      - MAXMIND_LICENSE_KEY=${MAXMIND_LICENSE_KEY}
      - PIXEL_ENDPOINT=/track
      - PIXEL_FILENAME=pixel.js
    volumes:
      - ./config/nginx/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro
      - ./lua:/opt/pixel/lua:ro
      - pixel_dist:/opt/pixel/dist:ro # Read built pixel from volume
      - logs_volume:/var/log/pixel
      - geoip_data:/opt/pixel/geoip:ro
    depends_on:
      init-perms:
        condition: service_completed_successfully
      pixel-builder:
        condition: service_completed_successfully
      geoip-updater:
        condition: service_started
    networks:
      - pixel_net

  # --- 1.5 GeoIP Updater ---
  geoip-updater:
    image: maxmindinc/geoipupdate
    container_name: pixel_geoip_updater
    restart: always
    environment:
      - GEOIPUPDATE_ACCOUNT_ID=${MAXMIND_ACCOUNT_ID}
      - GEOIPUPDATE_LICENSE_KEY=${MAXMIND_LICENSE_KEY}
      - GEOIPUPDATE_EDITION_IDS=GeoLite2-City
      - GEOIPUPDATE_FREQUENCY=168 # Update once a week (in hours)
    volumes:
      - geoip_data:/usr/share/GeoIP
    networks:
      - pixel_net

  # --- 2. Data Pipeline (Vector) ---
  vector:
    image: timberio/vector:0.34.1-alpine
    container_name: pixel_vector
    restart: always
    environment:
      - VECTOR_CONFIG=/etc/vector/vector.toml
    volumes:
      - ./config/vector/vector.toml:/etc/vector/vector.toml:ro
      - logs_volume:/var/log/pixel:ro # Read logs from shared volume
      - vector_data:/var/lib/vector
    depends_on:
      processor:
        condition: service_started
      init-perms:
        condition: service_completed_successfully
    networks:
      - pixel_net

  # --- 2.5. Processor (Go) ---
  processor:
    build:
      context: ./backend
      dockerfile: processor.Dockerfile
    container_name: pixel_processor
    restart: always
    environment:
      - PROCESSOR_PORT=8080
      - CLICKHOUSE_HOST=clickhouse:8123
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    depends_on:
      - clickhouse
    networks:
      - pixel_net

  # --- 3. Analytics DB (ClickHouse) ---
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: pixel_clickhouse
    restart: always
    ports:
      - "${CLICKHOUSE_HTTP_PORT}:8123" # HTTP port
      - "${CLICKHOUSE_NATIVE_PORT}:9000" # Native port
    environment:
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./config/clickhouse/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro
      # - ./config/clickhouse/users.xml:/etc/clickhouse-server/users.xml:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - pixel_net

  # --- 5. Backend API (Go) ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: pixel_backend
    restart: always
    ports:
      - "${BACKEND_PORT}:3000"
    environment:
      - CLICKHOUSE_HOST=clickhouse:8123
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - REPORT_DB_PATH=/app/data/reports.db
      - INITIAL_ADMIN_USER=admin
      - INITIAL_ADMIN_PASSWORD=secret
      - JWT_SECRET=change_me_in_prod
      - PIXEL_ENDPOINT=/track
      - PIXEL_FILENAME=pixel.js
    volumes:
      - backend_data:/app/data
    depends_on:
      - clickhouse
    networks:
      - pixel_net

  # --- 6. Frontend (React) ---
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: pixel_frontend
    restart: always
    ports:
      - "${FRONT_HOST_PORT}:${FRONT_CONTAINER_PORT}"
    depends_on:
      - backend
    networks:
      - pixel_net

networks:
  pixel_net:
    driver: bridge

volumes:
  logs_volume:
    name: pixel_logs_volume
  clickhouse_data:
    name: pixel_clickhouse_data
  vector_data:
    name: pixel_vector_data
  pixel_dist:
    name: pixel_pixel_dist
  geoip_data:
    name: pixel_geoip_data
  backend_data:
    name: pixel_backend_data
