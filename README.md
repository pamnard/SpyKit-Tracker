# SpyKit Analytics

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–µ–±-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –Ω–∞ JavaScript, Nginx –∏ Lua. SpyKit –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω–æ—Å—Ç–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏ –ø–æ–≤—Ç–æ—Ä–∞ –∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã–º –æ–±–æ–≥–∞—â–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö.

## ‚ö° –ó–∞–ø–∏—Å—å —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ Nginx vs –ó–∞–ø–∏—Å—å –≤ –ë–î

| –ê—Å–ø–µ–∫—Ç | **–ó–∞–ø–∏—Å—å —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ Nginx** | **–ó–∞–ø–∏—Å—å –≤ –ë–î** |
|--------|-----------------------------|-----------------|
| üöÄ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | 50,000+ RPS (~0.1ms) | ~1,000 RPS (10-50ms) |
| üõ°Ô∏è **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** | –í—Å–µ–≥–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç | –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ |
| üîß **–°–ª–æ–∂–Ω–æ—Å—Ç—å** | 2 —Å—Ç—Ä–æ—á–∫–∏ –∫–æ–¥–∞ | –ü—É–ª—ã, retry, –±–∞—Ç—á–∏–Ω–≥ |
| üí∞ **–†–µ—Å—É—Ä—Å—ã** | –¢–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–∏—Å–∫ | RAM + CPU + network –ø–æ—Å—Ç–æ—è–Ω–Ω–æ |
| üîÑ **–ê–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å** | –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –ë–î |
| üìä **–ó–∞–¥–µ—Ä–∂–∫–∞ –¥–∞–Ω–Ω—ã—Ö** | 5-15 –º–∏–Ω—É—Ç (–Ω–æ—Ä–º–∞ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ) | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ (–Ω–æ –∫–∞–∂–µ—Ç—Å—è —á—Ç–æ –Ω–µ —Å—Ç–æ–∏—Ç —Ç–æ–≥–æ) |

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏** - –ø—Ä–æ—Å–º–æ—Ç—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü, –∫–ª–∏–∫–∏, –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è
- **–ö—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –µ–¥–∏–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–º–µ–Ω–∞—Ö
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä —Å–æ–±—ã—Ç–∏–π** - –≥–ª—É–±–∏–Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, –≤–Ω–µ—à–Ω–∏–µ —Å—Å—ã–ª–∫–∏, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤, –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ SPA** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö —á–µ—Ä–µ–∑ History API
- **Visitor ID –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–ø–µ—á–∞—Ç–∫–∞** - —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ fingerprinting —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- **–°–±–æ—Ä UTM-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏** - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π —Ç–∞–π–º–∞—É—Ç –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

- **–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –±—ç–∫–µ–Ω–¥** - Nginx + Lua –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞ –º–µ–Ω–µ–µ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
- **–ü–∞–∫–µ—Ç–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π** - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- **–ú–µ—Ö–∞–Ω–∏–∑–º –ø–æ–≤—Ç–æ—Ä–æ–≤** - —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ localStorage
- **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞** - sendBeacon, fetch (keepalive), XMLHttpRequest –∫–∞–∫ fallback
- **–°–µ—Ä–≤–µ—Ä–Ω–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - IP-–≥–µ–æ–ª–æ–∫–∞—Ü–∏—è, –ø–∞—Ä—Å–∏–Ω–≥ user agent, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞

### –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **üîí Privacy-First –ø–æ–¥—Ö–æ–¥** - **–ù–ï —Å–æ–±–∏—Ä–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** (email, –∏–º–µ–Ω–∞, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–æ—Ä–º)
- **–ì–∏–±—Ä–∏–¥–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –∫—É–∫–∏ + localStorage –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏** - —É–≤–∞–∂–µ–Ω–∏–µ –∫ DoNotTrack, –æ–ø—Ü–∏–∏ –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–±—ã—Ç–∏–π
- **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
pixel/
‚îú‚îÄ‚îÄ pixel.js           # –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ pixel.lua          # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (Nginx + Lua)
‚îú‚îÄ‚îÄ batch.lua          # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–∫–µ—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (Nginx + Lua)
‚îú‚îÄ‚îÄ sync.lua           # –≠–Ω–¥–ø–æ–∏–Ω—Ç –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ nginx.conf         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π GeoIP
‚îú‚îÄ‚îÄ index.html         # –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
‚îî‚îÄ‚îÄ README.md          # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏:

```bash
# Ubuntu/Debian
sudo apt-get install nginx-module-geoip geoip-database

# –ò–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö MaxMind
wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz
wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.xz

# –†–∞—Å–ø–∞–∫—É–π—Ç–µ –≤ /usr/share/GeoIP/
sudo gunzip GeoIP.dat.gz
sudo mv GeoIP.dat /usr/share/GeoIP/
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π `nginx.conf` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Nginx:

```bash
sudo nginx -t  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo nginx -s reload
```

### 2. Lua-—Å–∫—Ä–∏–ø—Ç—ã

–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ Lua-—Å–∫—Ä–∏–ø—Ç—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:

- `pixel.lua` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–∏–Ω–æ—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ `/track`
- `batch.lua` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞–∫–µ—Ç—ã —Å–æ–±—ã—Ç–∏–π –Ω–∞ `/track/batch`
- `sync.lua` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –Ω–∞ `/sync`

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

–î–æ–±–∞–≤—å—Ç–µ –∫–æ–¥ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞ –≤–∞—à —Å–∞–π—Ç:

```html
<script>
  var _spy = (window._spy = window._spy || []);

  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  _spy.push(["config", "baseUrl", "https://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏.com"]);
  _spy.push(["config", "domains", ["example.com", "shop.example.com"]]);
  _spy.push(["config", "domainSync", true]);

  // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞
  (function () {
    var js = document.createElement("script");
    js.async = true;
    js.src = "/pixel.js";
    var f = document.getElementsByTagName("script")[0];
    f.parentNode.insertBefore(js, f);
  })();
</script>
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û–ø—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞

| –û–ø—Ü–∏—è                | –¢–∏–ø     | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ                                                       |
| -------------------- | ------- | ------------ | -------------------------------------------------------------- |
| `baseUrl`            | string  | `null`       | **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** - URL —Å–µ—Ä–≤–µ—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏                        |
| `namespace`          | string  | `'spyKit_'`  | –ü—Ä–µ—Ñ–∏–∫—Å –∫–ª—é—á–µ–π localStorage –∏ –∫—É–∫–∏                             |
| `domains`            | array   | `[]`         | –°–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö/–≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫ |
| `sessionTimeout`     | number  | `30`         | –¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö                                       |
| `batchSize`          | number  | `1`          | –°–æ–±—ã—Ç–∏—è –≤ –ø–∞–∫–µ—Ç–µ (1 = –æ—Ç–∫–ª—é—á–µ–Ω–æ)                               |
| `batchTimeout`       | number  | `5`          | –¢–∞–π–º–∞—É—Ç –ø–∞–∫–µ—Ç–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö                                      |
| `maxRetries`         | number  | `3`          | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π          |
| `retryDelay`         | number  | `1000`       | –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–≤—Ç–æ—Ä–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö                       |
| `maxFailedEvents`    | number  | `50`         | –ú–∞–∫—Å–∏–º—É–º –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ localStorage                      |
| `failedEventsTTL`    | number  | `86400000`   | TTL –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (24 —á–∞—Å–∞)                |
| `retryInterval`      | number  | `60000`      | –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (1 –º–∏–Ω—É—Ç–∞)          |
| `domainSync`         | boolean | `false`      | –í–∫–ª—é—á–∏—Ç—å –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é user ID                  |
| `scrollTracking`     | boolean | `true`       | –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≥–ª—É–±–∏–Ω—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏                                  |
| `clickTracking`      | boolean | `true`       | –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–ª–∏–∫–∏ –ø–æ –≤–Ω–µ—à–Ω–∏–º —Å—Å—ã–ª–∫–∞–º                           |
| `formTracking`       | boolean | `true`       | –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º                                      |
| `downloadTracking`   | boolean | `true`       | –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤                                  |
| `visibilityTracking` | boolean | `true`       | –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã                       |
| `debug`              | boolean | `false`      | –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å                                 |

### –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```javascript
// –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
_spy.push(["config", "baseUrl", "https://analytics.example.com"]);
_spy.push([
  "config",
  "domains",
  ["example.com", "shop.example.com", "blog.example.com"],
]);

// –í–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤
_spy.push(["config", "batchSize", 10]);
_spy.push(["config", "batchTimeout", 5]);

// –í–∫–ª—é—á–µ–Ω–∏–µ –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
_spy.push(["config", "domainSync", true]);

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–π
_spy.push(["config", "sessionTimeout", 60]); // 1-—á–∞—Å–æ–≤—ã–µ —Å–µ—Å—Å–∏–∏

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
_spy.push(["config", "scrollTracking", false]); // –û—Ç–∫–ª—é—á–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
```

## üéØ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ë–∞–∑–æ–≤–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

```javascript
// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
_spy.push(["track", "button_click", { button_id: "signup", page: "homepage" }]);
_spy.push(["track", "purchase", { value: 99.99, currency: "USD", items: 3 }]);
_spy.push(["track", "video_play", { video_id: "intro", duration: 120 }]);

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ user ID –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å CRM
_spy.push(["setUserId", "user_12345"]);

// –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–ª–∞–¥–∫–∏
_spy.push(["debug", true]);
```

### –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

```javascript
// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ e-commerce
_spy.push([
  "track",
  "add_to_cart",
  {
    product_id: "SKU123",
    product_name: "–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω—ã–µ –Ω–∞—É—à–Ω–∏–∫–∏",
    category: "–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞",
    price: 99.99,
    currency: "USD",
  },
]);

// –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–Ω—Ç
_spy.push([
  "track",
  "article_read",
  {
    article_id: "blog-post-123",
    category: "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
    read_percentage: 75,
    time_spent: 180, // —Å–µ–∫—É–Ω–¥—ã
  },
]);

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—É—Ç–∏
_spy.push([
  "track",
  "signup_step",
  {
    step: 2,
    step_name: "email_verification",
    funnel: "user_registration",
  },
]);
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ–ª–µ–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏—è

–ö–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –≤–∫–ª—é—á–∞–µ—Ç:

```json
{
  "event": "pageview",
  "data": {
    /* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è */
  },
  "url": "https://example.com/page",
  "referrer": "https://google.com",
  "userAgent": "Mozilla/5.0...",
  "ts": 1640995200000,
  "user_id": "user_123",
  "visitor_id": "fp_abc123def",
  "session_id": "sess_xyz789",
  "utm": {
    "utm_source": "google",
    "utm_medium": "cpc",
    "utm_campaign": "winter_sale"
  },
  "device": {
    "screenWidth": 1920,
    "screenHeight": 1080,
    "viewportWidth": 1200,
    "viewportHeight": 800,
    "language": "ru-RU",
    "timezone": "Europe/Moscow",
    "userAgent": "Mozilla/5.0...",
    "platform": "MacIntel",
    "touchSupport": false,
    "cookieEnabled": true
  }
}
```

### –°–µ—Ä–≤–µ—Ä–Ω–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ

–°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç:

```json
{
  "server": {
    "ip": "203.0.113.1",
    "real_ip": "203.0.113.1",
    "user_agent": "Mozilla/5.0...",
    "accept_language": "ru-RU,ru;q=0.9",
    "host": "example.com",
    "request_time": "0.001",
    "timestamp_server": 1640995200,
    "country": "RU",
    "country_name": "Russian Federation",
    "region": "Moscow City",
    "city": "Moscow",
    "postal_code": "101000",
    "latitude": 55.7558,
    "longitude": 37.6176
  }
}
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤

–°–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–∞–π–ª—ã, —Ä–∞–∑–±–∏—Ç—ã–µ –ø–æ –¥–∞—Ç–∞–º –∏ —á–∞—Å–∞–º –¥–ª—è —É–¥–æ–±–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:

```
/var/log/spykit/
‚îú‚îÄ‚îÄ events_2024-01-15_14.log          # –û–¥–∏–Ω–æ—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∑–∞ 15 —è–Ω–≤–∞—Ä—è 14:xx
‚îú‚îÄ‚îÄ events_2024-01-15_15.log          # –û–¥–∏–Ω–æ—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∑–∞ 15 —è–Ω–≤–∞—Ä—è 15:xx
‚îú‚îÄ‚îÄ batch_events_2024-01-15_14.log    # –ü–∞–∫–µ—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∑–∞ 15 —è–Ω–≤–∞—Ä—è 14:xx
‚îú‚îÄ‚îÄ batch_events_2024-01-15_15.log    # –ü–∞–∫–µ—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∑–∞ 15 —è–Ω–≤–∞—Ä—è 15:xx
‚îî‚îÄ‚îÄ ...
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–∞–∑–±–∏–≤–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏:

- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞** - —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ –¥–∞—Ç–µ
- **–ú–µ–Ω—å—à–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** - —Ñ–∞–π–ª—ã –Ω–µ —Ä–∞—Å—Ç—É—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
- **ETL-–¥—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Ä—Ü–∏—è–º–∏

### –ü—Ä–∏–º–µ—Ä—ã ETL –∫–æ–º–∞–Ω–¥:

```bash
# –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Å
python load_to_db.py /var/log/spykit/events_2024-01-15_14.log

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∑–∞ –¥–µ–Ω—å
python load_to_db.py /var/log/spykit/events_2024-01-15_*.log

# –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Å (–¥–ª—è cron)
python load_to_db.py /var/log/spykit/events_$(date +%Y-%m-%d_%H).log
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx

### –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```nginx
worker_processes 1;

# –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è GeoIP
load_module modules/ngx_http_geoip_module.so;

events {
    worker_connections 1024;
}

http {
    lua_shared_dict my_cache 10m;

    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö GeoIP
    geoip_country /usr/share/GeoIP/GeoIP.dat;
    geoip_city /usr/share/GeoIP/GeoLiteCity.dat;

    server {
        listen 8080;
        server_name –≤–∞—à-–¥–æ–º–µ–Ω-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏.com;

        # –û–¥–∏–Ω–æ—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
        location /track {
            content_by_lua_file /opt/spykit/pixel.lua;
        }

        # –ü–∞–∫–µ—Ç—ã —Å–æ–±—ã—Ç–∏–π
        location /track/batch {
            content_by_lua_file /opt/spykit/batch.lua;
        }

        # –ö—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫—É–∫–∏
        location /sync {
            content_by_lua_file /opt/spykit/sync.lua;
        }
    }
}
```

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```nginx
worker_processes auto;
worker_cpu_affinity auto;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # Gzip —Å–∂–∞—Ç–∏–µ
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types application/json text/plain;

    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
    limit_req_zone $binary_remote_addr zone=analytics:10m rate=100r/s;

    server {
        listen 443 ssl http2;
        server_name analytics.–≤–∞—à–¥–æ–º–µ–Ω.com;

        # SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        ssl_certificate /etc/ssl/certs/spykit.crt;
        ssl_certificate_key /etc/ssl/private/spykit.key;

        # –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏
        location /track {
            limit_req zone=analytics burst=50 nodelay;
            content_by_lua_file /opt/spykit/pixel.lua;
        }

        location /track/batch {
            limit_req zone=analytics burst=20 nodelay;
            content_by_lua_file /opt/spykit/batch.lua;
        }

        location /sync {
            limit_req zone=analytics burst=10 nodelay;
            content_by_lua_file /opt/spykit/sync.lua;
        }
    }
}
```

## üîÑ Lua-—Å–∫—Ä–∏–ø—Ç—ã

### pixel.lua - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π —Å —Å–µ—Ä–≤–µ—Ä–Ω—ã–º –æ–±–æ–≥–∞—â–µ–Ω–∏–µ–º:

```lua
-- –ó–∞–≥—Ä—É–∑–∫–∞ JSON –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
local cjson = require "cjson"

-- –ß—Ç–µ–Ω–∏–µ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
ngx.req.read_body()
local data = ngx.req.get_body_data()

if data then
    -- –ü–∞—Ä—Å–∏–Ω–≥ JSON
    local success, event = pcall(cjson.decode, data)

    if success then
        -- –û–±–æ–≥–∞—â–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è —Å–µ—Ä–≤–µ—Ä–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        event.server = {
            ip = ngx.var.remote_addr,
            real_ip = ngx.var.http_x_forwarded_for or ngx.var.remote_addr,
            -- GeoIP –¥–∞–Ω–Ω—ã–µ
            country = ngx.var.geoip_country_code or "Unknown",
            city = ngx.var.geoip_city or "Unknown",
            -- ... –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ
        }

        -- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É –ª–æ–≥–æ–≤ —Å –¥–∞—Ç–æ–π –∏ —á–∞—Å–æ–º
        local timestamp = os.date("*t")
        local log_dir = "/var/log/spykit"
        local log_file = string.format("%s/events_%04d-%02d-%02d_%02d.log",
            log_dir, timestamp.year, timestamp.month, timestamp.day, timestamp.hour)

        -- –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        os.execute("mkdir -p " .. log_dir)

        -- –ó–∞–ø–∏—Å—å –æ–±–æ–≥–∞—â—ë–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
        local enriched_data = cjson.encode(event)
        local file = io.open(log_file, "a")
        file:write(enriched_data .. "\n")
        file:close()
    end
end

ngx.status = 204
ngx.exit(204)
```

### batch.lua - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–∫–µ—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏–π –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ:

```lua
-- –ü–∞—Ä—Å–∏–Ω–≥ JSON –º–∞—Å—Å–∏–≤–∞ —Å–æ–±—ã—Ç–∏–π
local success, events = pcall(cjson.decode, data)

if success and type(events) == "table" then
    -- –û–±–æ–≥–∞—â–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –≤ –ø–∞–∫–µ—Ç–µ
    for i, event in ipairs(events) do
        if type(event) == "table" then
            event.server = {
                -- –¢–æ –∂–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ, —á—Ç–æ –∏ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
            }
        end
    end

    -- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É –ª–æ–≥–æ–≤ —Å –¥–∞—Ç–æ–π –∏ —á–∞—Å–æ–º
    local timestamp = os.date("*t")
    local log_dir = "/var/log/spykit"
    local log_file = string.format("%s/batch_events_%04d-%02d-%02d_%02d.log",
        log_dir, timestamp.year, timestamp.month, timestamp.day, timestamp.hour)

    -- –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    os.execute("mkdir -p " .. log_dir)

    -- –ó–∞–ø–∏—Å—å –æ–±–æ–≥–∞—â—ë–Ω–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞
    local enriched_data = cjson.encode(events)
    local file = io.open(log_file, "a")
    file:write(enriched_data .. "\n")
    file:close()
end
```

### sync.lua - –ö—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç user ID –º–µ–∂–¥—É –¥–æ–º–µ–Ω–∞–º–∏ —á–µ—Ä–µ–∑ –ø–∏–∫—Å–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

```lua
-- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL
local args = ngx.req.get_uri_args()
local visitor_id = args.visitor_id

-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—É–∫–∏ –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–º –¥–æ–º–µ–Ω–µ
local host = ngx.var.host
local domain = "." .. host -- –£–ø—Ä–æ—â–µ–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
local expires = ngx.cookie_time(ngx.time() + 365 * 24 * 3600)
local cookie_value = string.format("spyKit_visitor_id=%s; expires=%s; domain=%s; path=/",
    visitor_id, expires, domain)

ngx.header["Set-Cookie"] = cookie_value

-- –í–æ–∑–≤—Ä–∞—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ GIF 1x1
ngx.header.content_type = "image/gif"
local gif_data = string.char(0x47, 0x49, 0x46, 0x38, 0x39, 0x61, 0x01, 0x00, 0x01, 0x00, 0x80, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x21, 0xF9, 0x04, 0x01, 0x00, 0x00, 0x00, 0x00, 0x2C, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x02, 0x02, 0x04, 0x01, 0x00, 0x3B)
ngx.print(gif_data)
```

## üîí –ö—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ

SpyKit –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é visitor ID –º–µ–∂–¥—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥–æ–º–µ–Ω–∞–º–∏:

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ü–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å–µ—â–∞–µ—Ç `example.com`, –ø–æ–ª—É—á–∞–µ—Ç `visitor_id` —á–µ—Ä–µ–∑ fingerprinting
2. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: –ü–∏–∫—Å–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫–æ –≤—Å–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º –¥–æ–º–µ–Ω–∞–º
3. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—É–∫–∏**: –ö–∞–∂–¥—ã–π –¥–æ–º–µ–Ω –ø–æ–ª—É—á–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ—Ç –∂–µ `visitor_id`
4. **–ï–¥–∏–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ –Ω–∞ –≤—Å–µ—Ö –¥–æ–º–µ–Ω–∞—Ö

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```javascript
// –í–∫–ª—é—á–µ–Ω–∏–µ –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
_spy.push(["config", "domainSync", true]);
_spy.push([
  "config",
  "domains",
  [
    "example.com",
    "shop.example.com",
    "blog.example.com",
    "support.example.com",
  ],
]);
```

### –ü–æ—Ç–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å–µ—â–∞–µ—Ç example.com
    ‚Üì
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è visitor_id: fp_abc123
    ‚Üì
–û—Ç–ø—Ä–∞–≤–∫–∞ sync –∑–∞–ø—Ä–æ—Å–æ–≤:
- https://shop.example.com/sync?visitor_id=fp_abc123
- https://blog.example.com/sync?visitor_id=fp_abc123
- https://support.example.com/sync?visitor_id=fp_abc123
    ‚Üì
–ö–∞–∂–¥—ã–π –¥–æ–º–µ–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫—É–∫–∏: spyKit_visitor_id=fp_abc123
    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π ID –Ω–∞ –≤—Å–µ—Ö –¥–æ–º–µ–Ω–∞—Ö
```

## üéõÔ∏è –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### –ü–∞–∫–µ—Ç–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π

–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π:

```javascript
// –í–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
_spy.push(["config", "batchSize", 10]); // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å–ª–µ 10 —Å–æ–±—ã—Ç–∏–π
_spy.push(["config", "batchTimeout", 5]); // –ò–ª–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥

// –°–æ–±—ã—Ç–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –≤ –ø–∞–∫–µ—Ç—ã
_spy.push(["track", "click", { button: "header_login" }]);
_spy.push(["track", "click", { button: "product_view" }]);
_spy.push(["track", "scroll", { depth: 25 }]);
// ... –±–æ–ª—å—à–µ —Å–æ–±—ã—Ç–∏–π –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ
```

### –ú–µ—Ö–∞–Ω–∏–∑–º –ø–æ–≤—Ç–æ—Ä–æ–≤

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–≤—Ç–æ—Ä —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:

```javascript
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–æ–≤
_spy.push(["config", "maxRetries", 5]); // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–≤—Ç–æ—Ä–∞
_spy.push(["config", "retryDelay", 1000]); // –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 1—Å, 2—Å, 4—Å, 8—Å...
_spy.push(["config", "retryInterval", 60000]); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
```

### –û—Ç–ø–µ—á–∞—Ç–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö user ID –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:

- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ –∏ –≥–ª—É–±–∏–Ω–∞ —Ü–≤–µ—Ç–∞
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –∏ —è–∑—ã–∫–∞
- –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (—è–¥—Ä–∞ CPU, –ø–∞–º—è—Ç—å)
- Canvas fingerprinting (–ø–∞—Å—Å–∏–≤–Ω—ã–π)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ touch –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–µ–≤–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏

### –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏

–í–∫–ª—é—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

```javascript
// –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–ª–∞–¥–∫–∏
_spy.push(["debug", true]);

// –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ ID
// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤
```

## üìà –°–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**: –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **–ü–∞–∫–µ—Ç–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π**: –°–Ω–∏–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
- **–†–µ–∑–µ—Ä–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage**: –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏

### –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- **Nginx + Lua**: –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –º–µ–Ω–µ–µ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –ë–î**: –ü—Ä—è–º–∞—è –∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è GeoIP**: –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ IP
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏**: –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

- **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–æ–ª—å—à–µ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ Nginx –∑–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–º –Ω–∞–≥—Ä—É–∑–∫–∏
- **–†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤**: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è logrotate –¥–ª—è –ª–æ–≥–æ–≤ —Å–æ–±—ã—Ç–∏–π
- **–ü–∞–π–ø–ª–∞–π–Ω –¥–∞–Ω–Ω—ã—Ö**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–≥–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –≤—Ä–æ–¥–µ Fluentd, Logstash –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å–∫—Ä–∏–ø—Ç–∞–º–∏
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ë–î**: –ò–º–ø–æ—Ä—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ ClickHouse, BigQuery –∏ —Ç.–¥.

## üîê –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ

### –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ GDPR

```javascript
// –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
_spy.push(["config", "scrollTracking", false]);
_spy.push(["config", "clickTracking", false]);
_spy.push(["config", "formTracking", false]);
_spy.push(["config", "downloadTracking", false]);
_spy.push(["config", "visibilityTracking", false]);
```

### –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

SpyKit –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é **–ù–ï —Å–æ–±–∏—Ä–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**:

#### ‚ùå –ß—Ç–æ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å —Ñ—Ä–æ–Ω—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

- Email –∞–¥—Ä–µ—Å–∞, –∏–º–µ–Ω–∞, —Ç–µ–ª–µ—Ñ–æ–Ω—ã
- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–æ—Ä–º (–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏)
- –õ—é–±—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
- –î–∞–Ω–Ω—ã–µ, —Ç—Ä–µ–±—É—é—â–∏–µ —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### ‚úÖ –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ**: URL, referrer, —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞, —è–∑—ã–∫ –±—Ä–∞—É–∑–µ—Ä–∞
- **–û–±–µ–∑–ª–∏—á–µ–Ω–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã**: `visitor_id` (fingerprint), `session_id`, `user_id` (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ)
- **–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è**: –ø—Ä–æ—Å–º–æ—Ç—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü, –∫–ª–∏–∫–∏ –ø–æ –≤–Ω–µ—à–Ω–∏–º —Å—Å—ã–ª–∫–∞–º, —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

#### ‚ö†Ô∏è –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –¢–û–õ–¨–ö–û –ø—Ä–∏ —è–≤–Ω–æ–º —É–∫–∞–∑–∞–Ω–∏–∏:

```javascript
// –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
// –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å –∏—Ö –≤ –∫–æ–¥–µ:
_spy.push([
  "track",
  "signup",
  {
    email: "user@example.com", // ‚Üê –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¢–´ —Ç–∞–∫ –Ω–∞–ø–∏—Å–∞–ª
    name: "John Doe", // ‚Üê –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¢–´ —Ç–∞–∫ –Ω–∞–ø–∏—Å–∞–ª
  },
]);

// CRM ID —Ç–æ–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —è–≤–Ω–æ
_spy.push(["setUserId", "crm_user_123"]);
```

#### üõ°Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏:

- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–µ—Ä–∏–æ–¥—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –û–ø—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Nginx —Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
2. –û–±—Å–ª—É–∂–∏–≤–∞–π—Ç–µ `index.html` —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
3. –û—Ç–∫—Ä–æ–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π
4. –í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: `_spy.push(['debug', true])`

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π

```javascript
// –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
_spy.push(["track", "test_event", { test: true }]);

// –¢–µ—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ user ID
_spy.push(["setUserId", "test_user_123"]);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Å–∞
tail -f /var/log/spykit/events_$(date +%Y-%m-%d_%H).log

# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ª–æ–≥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
tail -f /var/log/spykit/events_$(date +%Y-%m-%d)_*.log
```

## üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
sudo mkdir -p /opt/spykit
sudo mkdir -p /var/log/spykit

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
sudo cp pixel.lua batch.lua sync.lua /opt/spykit/
sudo cp nginx.conf /etc/nginx/sites-available/spykit.conf

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤
sudo chown -R nginx:nginx /opt/spykit
sudo chown -R nginx:nginx /var/log/spykit
sudo chmod 755 /opt/spykit/*.lua

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx
sudo ln -s /etc/nginx/sites-available/spykit.conf /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx
```

### –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π DNS –¥–ª—è –¥–æ–º–µ–Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö GeoIP
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ª–æ–≥–æ–≤ —Å–æ–±—ã—Ç–∏–π

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫:

- –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞
- –ß–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫ –∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞
- –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö GeoIP
- –†–∞–∑–º–µ—Ä—ã –ª–æ–≥-—Ñ–∞–π–ª–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞

## üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ API

### –ö–æ–º–∞–Ω–¥—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```javascript
_spy.push(["config", "–∫–ª—é—á", "–∑–Ω–∞—á–µ–Ω–∏–µ"]);
```

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

```javascript
_spy.push(["track", "–Ω–∞–∑–≤–∞–Ω–∏–µ_—Å–æ–±—ã—Ç–∏—è", { –¥–∞–Ω–Ω—ã–µ }]);
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

```javascript
_spy.push(["setUserId", "user_id"]);
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–æ–π

```javascript
_spy.push(["debug", true]);
_spy.push(["debug", false]);
```

## ü§ù –í–∫–ª–∞–¥ –≤ –ø—Ä–æ–µ–∫—Ç

1. –°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ä–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
2. –°–æ–∑–¥–∞–π—Ç–µ –≤–µ—Ç–∫—É –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏
3. –í–Ω–µ—Å–∏—Ç–µ –≤–∞—à–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
4. –¢—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ
5. –û—Ç–ø—Ä–∞–≤—å—Ç–µ pull request

## üÜò –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–°–æ–±—ã—Ç–∏—è –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö**

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ Nginx
- –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π Lua-—Å–∫—Ä–∏–ø—Ç–æ–≤
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞—Ä—Å–∏–Ω–≥ JSON —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º —Ä–µ–∂–∏–º–æ–º –æ—Ç–ª–∞–¥–∫–∏

**–ö—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–æ–º–µ–Ω–æ–≤
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç `/sync` –¥–æ—Å—Ç—É–ø–µ–Ω
- –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å –æ–¥–Ω–∏–º –¥–æ–º–µ–Ω–æ–º

**–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä**

- –í–∫–ª—é—á–∏—Ç–µ –ø–∞–∫–µ—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–±—ã—Ç–∏–π
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç—Ä–∞—Ñ–∏–∫ –±–æ—Ç–æ–≤
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Ä–µ—Å—É—Ä—Å—ã —Å–µ—Ä–≤–µ—Ä–∞

### –ö–æ–º–∞–Ω–¥—ã –æ—Ç–ª–∞–¥–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx
sudo nginx -t

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –æ—à–∏–±–æ–∫ Nginx
sudo tail -f /var/log/nginx/error.log

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ —Å–æ–±—ã—Ç–∏–π
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º JSON
tail -f /var/log/spykit/events_$(date +%Y-%m-%d_%H).log | jq '.'

# –ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –¥–∞—Ç—É
cat /var/log/spykit/events_2024-01-15_*.log | jq '.event' | sort | uniq -c

# –†—É—á–Ω–æ–π —Ç–µ—Å—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
curl -X POST https://–≤–∞—à-–¥–æ–º–µ–Ω.com/track \
  -H "Content-Type: application/json" \
  -d '{"event":"test","data":{"source":"manual"}}'
```
