!function(t,e){"use strict";const i=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}),s=()=>{try{const t=[navigator.userAgent,screen.width+"x"+screen.height,(new Date).getTimezoneOffset(),navigator.language].join("|");let e=0;for(let i=0;i<t.length;i++){e=(e<<5)-e+t.charCodeAt(i),e&=e}return"fp_"+Math.abs(e).toString(36)}catch(t){return"rn_"+Math.random().toString(36).substr(2,12)}},n=(t,...e)=>{t&&console.log("[SpyKit]",...e)},o=(...t)=>{console.error("[SpyKit]",...t)};class r{constructor(){this.values={baseUrl:null,endpoint:"/track",sessionTimeout:30,maxRetries:3,retryDelay:1e3,batchSize:1,batchTimeout:5,scrollTracking:!0,clickTracking:!0,formTracking:!0,downloadTracking:!0,visibilityTracking:!0,domains:[],domainSync:!1,namespace:"spyKit_",maxFailedEvents:50,failedEventsTTL:864e5,retryInterval:6e4,debug:!1}}set(t,e){return!!this.validate(t,e)&&(this.values[t]=e,!0)}get(t){return this.values[t]}validate(t,e){const i={baseUrl:t=>"string"==typeof t&&t.length>0,endpoint:t=>"string"==typeof t&&t.startsWith("/"),batchSize:t=>"number"==typeof t&&t>=1,debug:t=>"boolean"==typeof t,domains:t=>Array.isArray(t)};return!(i[t]&&!i[t](e))||(o(`Invalid config value for ${t}:`,e),!1)}getEndpointUrl(){if(!this.values.baseUrl)throw new Error("baseUrl not configured");return this.values.baseUrl.replace(/\/$/,"")+this.values.endpoint}}class a{constructor(t){this.config=t}get(t){const e=this.config.get("namespace")+t;return this.getCookie(e)||this.getLocalStorage(e)}set(t,e,i=365){const s=this.config.get("namespace")+t;this.setCookie(s,e,i),this.setLocalStorage(s,e)}getCookie(t){const i=e.cookie.match("(^|;) ?"+t+"=([^;]*)(;|$)");return i?i[2]:null}setCookie(t,i,s){try{const n=new Date;n.setTime(n.getTime()+864e5*s);const o=this.getRootDomain();e.cookie=`${t}=${i};path=/;expires=${n.toGMTString()};domain=${o};SameSite=Lax`}catch(t){}}getLocalStorage(t){try{return localStorage.getItem(t)}catch(t){return null}}setLocalStorage(t,e){try{localStorage.setItem(t,e)}catch(t){}}getRootDomain(){const e=t.location.hostname.split(".");return e.length>2?"."+e.slice(-2).join("."):t.location.hostname}}class c{constructor(){this.adBlockActive=null,this.checkAdBlock()}getInfo(){return{screenWidth:screen.width,screenHeight:screen.height,viewportWidth:t.innerWidth,viewportHeight:t.innerHeight,screenAvailWidth:screen.availWidth,screenAvailHeight:screen.availHeight,colorDepth:screen.colorDepth,pixelRatio:t.devicePixelRatio||1,orientation:(screen.orientation?screen.orientation.type:"")||t.orientation||"",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,language:navigator.language,languages:navigator.languages?Array.from(navigator.languages):[navigator.language],userAgent:navigator.userAgent,platform:navigator.platform,webdriver:navigator.webdriver,pdfViewerEnabled:navigator.pdfViewerEnabled,doNotTrack:"1"===navigator.doNotTrack||"yes"===navigator.doNotTrack,cookieEnabled:navigator.cookieEnabled,adBlock:this.adBlockActive,gpuRenderer:this.getGPU(),performance:this.getPerformance(),connection:this.getConnection()}}getGPU(){try{const t=e.createElement("canvas"),i=t.getContext("webgl")||t.getContext("experimental-webgl");if(!i)return null;const s=i.getExtension("WEBGL_debug_renderer_info");return s?i.getParameter(s.UNMASKED_RENDERER_WEBGL):null}catch(t){return null}}getPerformance(){if(!t.performance||!t.performance.getEntriesByType)return null;const e=t.performance.getEntriesByType("navigation")[0];return e?{ttfb:Math.round(e.responseStart-e.requestStart),domLoad:Math.round(e.domContentLoadedEventEnd-e.requestStart),fullLoad:Math.round(e.loadEventEnd>0?e.loadEventEnd-e.requestStart:0)}:null}getConnection(){const t=navigator.connection;return t?{effectiveType:t.effectiveType,downlink:t.downlink,rtt:t.rtt,saveData:t.saveData}:null}checkAdBlock(){if(e.body)try{const t=e.createElement("div");t.className="adsbox banner-ads",t.style.cssText="position:absolute;top:-999px;left:-999px;height:1px;width:1px;",e.body.appendChild(t),setTimeout(()=>{this.adBlockActive=null===t.offsetParent||0===t.offsetHeight,t.parentNode&&t.parentNode.removeChild(t)},100)}catch(t){this.adBlockActive=!1}else t.addEventListener("DOMContentLoaded",()=>this.checkAdBlock())}}class h{constructor(t,e){this.storage=t,this.config=e,this.visitorId=this.getOrSetVisitorId(),this.userId=this.storage.get("user_id"),this.sessionId=this.refreshSession()}getOrSetVisitorId(){let t=this.storage.get("visitor_id");return t||(t=s(),this.storage.set("visitor_id",t)),t}setUserId(t){this.userId=t,this.storage.set("user_id",t)}refreshSession(){const t=Date.now();let e={};try{e=JSON.parse(this.storage.get("session")||"{}")}catch(t){}const s=60*this.config.get("sessionTimeout")*1e3;return!e.id||!e.ts||t-e.ts>s?e={id:i(),ts:t}:e.ts=t,this.storage.set("session",JSON.stringify(e)),e.id}getContext(){return{uid:this.userId,device_id:this.visitorId,session_id:this.sessionId}}}class l{constructor(e,i){this.config=e,this.storage=i,this.queue=[],this.timer=null,setInterval(()=>this.retryFailed(),this.config.get("retryInterval")),t.addEventListener("beforeunload",()=>this.flush(!0)),t.addEventListener("pagehide",()=>this.flush(!0))}send(t){this.queue.push(t),n(this.config.get("debug"),"Queued event:",t.event_name),this.queue.length>=this.config.get("batchSize")?this.flush():!this.timer&&this.config.get("batchSize")>1?this.timer=setTimeout(()=>this.flush(),1e3*this.config.get("batchTimeout")):1===this.config.get("batchSize")&&this.flush()}flush(t=!1){if(0===this.queue.length)return;const e=[...this.queue];this.queue=[],this.timer&&(clearTimeout(this.timer),this.timer=null);const i=this.config.getEndpointUrl(),s=1===e.length?JSON.stringify(e[0]):JSON.stringify(e);t&&navigator.sendBeacon?navigator.sendBeacon(i,s):this.sendXHR(i,s,e)}sendXHR(t,e,i,s=0){const o=new XMLHttpRequest;o.open("POST",t,!0),o.setRequestHeader("Content-Type","application/json"),o.onload=()=>{o.status>=200&&o.status<300?n(this.config.get("debug"),"Sent batch",i):(o.status>=500||429===o.status)&&this.handleFail(i,s)},o.onerror=()=>this.handleFail(i,s),o.send(e)}handleFail(t,e){const i=this.config.get("maxRetries");if(e<i){const i=this.config.get("retryDelay")*Math.pow(2,e);setTimeout(()=>{const i=JSON.stringify(t);this.sendXHR(this.config.getEndpointUrl(),i,t,e+1)},i)}else this.saveFailed(t)}saveFailed(t){try{let e=JSON.parse(this.storage.get("failed")||"[]");t.forEach(t=>{e.push({event:t,ts:Date.now(),attempts:this.config.get("maxRetries")})}),e.length>this.config.get("maxFailedEvents")&&(e=e.slice(-this.config.get("maxFailedEvents"))),this.storage.set("failed",JSON.stringify(e))}catch(t){}}retryFailed(){const t=this.storage.get("failed");if(t)try{let e=JSON.parse(t);const i=Date.now(),s=this.config.get("failedEventsTTL");if(e=e.filter(t=>i-t.ts<s),e.length>0){const t=e.map(t=>t.event);this.sendXHR(this.config.getEndpointUrl(),JSON.stringify(t),t),this.storage.set("failed","[]")}}catch(t){}}}class g{constructor(t,e){this.pixel=t,this.config=e,this.init()}init(){this.config.get("scrollTracking")&&this.trackScroll(),this.config.get("clickTracking")&&this.trackClicks(),this.config.get("formTracking")&&this.trackForms(),this.config.get("visibilityTracking")&&this.trackVisibility(),this.config.get("downloadTracking")&&this.trackDownloads(),this.trackHistory()}trackScroll(){let i=0,s=null;t.addEventListener("scroll",()=>{const n=Math.round((t.pageYOffset+t.innerHeight)/e.body.scrollHeight*100);n>i&&(i=n,clearTimeout(s),s=setTimeout(()=>{this.pixel.track("scroll",{depth:Math.min(i,100)})},500))},{passive:!0})}trackClicks(){e.addEventListener("click",e=>{const i=e.target.closest("a");if(!i)return;const s=i.href,n=i.hostname,o=t.location.hostname;if(n&&n!==o&&this.config.get("clickTracking")){const t=this.isInternalDomain(n);this.pixel.track(t?"internal_click":"external_click",{url:s,text:i.textContent?.trim(),domain:n,is_cross_domain:t})}if(this.config.get("downloadTracking")){const t=s.split(".").pop()?.toLowerCase();t&&/^(pdf|doc|docx|xls|xlsx|ppt|pptx|zip|rar|7z|exe|mp3|mp4|avi|mov)$/.test(t)&&this.pixel.track("file_download",{url:s,extension:t,filename:s.split("/").pop()})}})}isInternalDomain(t){const e=this.config.get("domains")||[];return e.includes(t)||e.some(e=>t.endsWith("."+e))}trackForms(){e.addEventListener("submit",t=>{const e=t.target;if("FORM"!==e.tagName)return;const i=Array.from(e.elements).filter(t=>t.name&&"submit"!==t.type&&"password"!==t.type).map(t=>t.name);this.pixel.track("form_submit",{id:e.id,action:e.action,fields:i})})}trackVisibility(){let t=Date.now(),i=!e.hidden;e.addEventListener("visibilitychange",()=>{e.hidden&&i?(this.pixel.track("page_hidden",{time_visible:Math.round((Date.now()-t)/1e3)}),i=!1):e.hidden||i||(this.pixel.track("page_visible",{}),t=Date.now(),i=!0)})}trackDownloads(){}trackHistory(){const e=history.pushState;history.pushState=function(){e.apply(this,arguments),t.dispatchEvent(new Event("spy:location"))},t.addEventListener("popstate",()=>t.dispatchEvent(new Event("spy:location"))),t.addEventListener("spy:location",()=>this.pixel.track("pageview"))}}t.SpyPixel=new class{constructor(){this.config=new r,this.storage=new a(this.config),this.session=null,this.device=new c,this.transport=null,this.autoEvents=null,this.processQueue()}init(){this.session=new h(this.storage,this.config),this.transport=new l(this.config,this.storage),this.autoEvents=new g(this,this.config),this.config.get("domainSync")&&this.syncDomains(),this.track("pageview"),n(this.config.get("debug"),"SpyPixel initialized")}push(t){if(!Array.isArray(t))return;const[e,...i]=t;switch(e){case"config":this.config.set(i[0],i[1]);break;case"track":this.track(i[0],i[1]);break;case"setUserId":this.session&&this.session.setUserId(i[0]);break;case"debug":this.config.set("debug",i[0])}"config"!==e||"baseUrl"!==i[0]||this.transport||this.init()}track(i,s={}){if(!this.transport)return;const n=this.session.getContext(),o=this.device.getInfo(),r={event_name:i,timestamp:Date.now()/1e3,uid:n.uid,device_id:n.device_id,session_id:n.session_id,url:t.location.href,referrer:e.referrer,user_agent:navigator.userAgent,device:o,utm:this.getUTM(),data:s};this.transport.send(r)}getUTM(){const e=new URLSearchParams(t.location.search),i={};return["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(t=>{e.has(t)&&(i[t]=e.get(t))}),i}processQueue(){const e=t._spy||[];t._spy={push:t=>this.push(t)},e.forEach(t=>this.push(t))}syncDomains(){const e=this.config.get("domains")||[],i=t.location.hostname,s=this.session.visitorId;e.filter(t=>t!==i).forEach(t=>{(new Image).src=`https://${t}/sync?visitor_id=${s}`})}}}(window,document);