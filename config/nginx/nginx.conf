worker_processes  auto;

# Logs to stderr/stdout for Docker
error_log /dev/stderr warn;
pid       /usr/local/openresty/nginx/logs/nginx.pid;

# Expose env vars to Lua
env MAXMIND_ACCOUNT_ID;
env MAXMIND_LICENSE_KEY;

events {
    worker_connections  10240;
    multi_accept on;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;

    # Shared memory for settings cache
    lua_shared_dict settings_cache 1m;
    lua_package_path "/opt/spykit/lua/?.lua;;";

    # Custom log format
    log_format  json_combined escape=json
      '{'
        '"time_local":"$time_local",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"request":"$request",'
        '"status": "$status",'
        '"body_bytes_sent":"$body_bytes_sent",'
        '"request_time":"$request_time",'
        '"http_referrer":"$http_referer",'
        '"http_user_agent":"$http_user_agent"'
      '}';

    access_log /dev/stdout json_combined;

    server {
        listen 80;
        server_name localhost;

        # Internal location for backend requests
        location /internal_backend/ {
            internal;
            rewrite ^/internal_backend/(.*) /$1 break;
            proxy_pass http://spykit_backend:3000;
        }

        # Health check
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # Sync endpoint (static for now, or move to router if needed)
        location /sync {
             content_by_lua_file /opt/spykit/lua/sync.lua;
        }

        # Dynamic router for pixel and tracking
        location / {
            content_by_lua_file /opt/spykit/lua/router.lua;
        }
    }
}
